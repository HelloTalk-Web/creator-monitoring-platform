# åç«¯æ¶æ„è®¾è®¡è¯´æ˜

## ğŸ“ æ¨¡å—èŒè´£åˆ’åˆ†

### 1. **Scrapers æ¨¡å—** (çˆ¬è™«æ¨¡å—)
**è·¯å¾„**: `src/modules/scrapers/`
**èŒè´£**: æ•°æ®æŠ“å–å’Œå­˜å‚¨

#### æ ¸å¿ƒç»„ä»¶:
- **Crawlers** (`crawlers/`): å¹³å°é€‚é…å™¨
  - `ICrawler`: çˆ¬è™«æ¥å£å®šä¹‰
  - `TikTok.ts`: TikTokå¹³å°é€‚é…å™¨
  - å…¶ä»–å¹³å°é€‚é…å™¨...

- **Manager** (`manager/scraper.manager.ts`): ä¸šåŠ¡é€»è¾‘å±‚
  - `scrapeAndStoreCreatorAccount()`: æŠ“å–å¹¶å­˜å‚¨åˆ›ä½œè€…è´¦å·å’Œè§†é¢‘
  - `updateVideoByUrl()`: æ›´æ–°å•ä¸ªè§†é¢‘æ•°æ®
  - ç›´æ¥æ“ä½œæ•°æ®åº“(å†…ç½®ä»“å‚¨å±‚)

- **Controller** (`controller/scraper.controller.ts`): HTTPè¯·æ±‚å¤„ç†
  - `parseUrl()`: è§£æURL
  - `scrapeProfile()`: æŠ“å–ç”¨æˆ·èµ„æ–™
  - `scrapeVideos()`: æŠ“å–è§†é¢‘åˆ—è¡¨
  - `scrapeComplete()`: æŠ“å–å®Œæ•´ä¿¡æ¯
  - `updateVideo()`: æ›´æ–°è§†é¢‘æ•°æ®

#### APIç«¯ç‚¹:
```
POST /api/scrape/parse-url      - è§£æURLè¯†åˆ«å¹³å°
POST /api/scrape/profile         - æŠ“å–ç”¨æˆ·èµ„æ–™
POST /api/scrape/videos          - æŠ“å–è§†é¢‘åˆ—è¡¨
POST /api/scrape/complete        - æŠ“å–å®Œæ•´ä¿¡æ¯(æ¨è)
POST /api/scrape/update-video    - æ›´æ–°å•ä¸ªè§†é¢‘
POST /api/scrape/batch           - æ‰¹é‡æŠ“å–(TODO)
```

---

### 2. **Platforms æ¨¡å—** (å¹³å°ç®¡ç†æ¨¡å—)
**è·¯å¾„**: `src/modules/platforms/`
**èŒè´£**: çº¯CRUDæ“ä½œï¼Œä¸è§¦å‘çˆ¬è™«

#### æ ¸å¿ƒç»„ä»¶:
- **Repository** (`repository/platform.repository.ts`): æ•°æ®è®¿é—®å±‚
  - æ•°æ®åº“CRUDæ“ä½œ

- **Manager** (`managers/platform.manager.ts`): ä¸šåŠ¡é€»è¾‘å±‚
  - `createOrUpdateCreatorAccount()`: çº¯CRUDæ“ä½œ
  - **ä¸åŒ…å«çˆ¬è™«é€»è¾‘**

- **Service** (`service/platform.service.ts`): æœåŠ¡å±‚
  - å¤æ‚æŸ¥è¯¢å’Œä¸šåŠ¡é€»è¾‘

- **Controller** (`controller/platform.controller.ts`): HTTPè¯·æ±‚å¤„ç†
  - `getCreatorAccounts()`: è·å–è´¦å·åˆ—è¡¨
  - `getCreatorAccount()`: è·å–è´¦å·è¯¦æƒ…
  - `updateCreatorAccount()`: æ›´æ–°è´¦å·ä¿¡æ¯
  - `deleteCreatorAccount()`: åˆ é™¤è´¦å·

#### APIç«¯ç‚¹:
```
GET    /api/platforms/accounts        - è·å–è´¦å·åˆ—è¡¨
GET    /api/platforms/accounts/:id    - è·å–è´¦å·è¯¦æƒ…
PUT    /api/platforms/accounts/:id    - æ›´æ–°è´¦å·(çº¯CRUD)
DELETE /api/platforms/accounts/:id    - åˆ é™¤è´¦å·
```

---

## ğŸ”„ æ•°æ®æµè®¾è®¡

### æ·»åŠ æ–°è´¦å·æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         â”‚  URL   â”‚              â”‚        â”‚                 â”‚
â”‚ å‰ç«¯UI  â”‚â”€â”€â”€â”€â”€â”€â”€>â”‚ Scraper API  â”‚â”€â”€â”€â”€â”€â”€â”€>â”‚ ScraperManager  â”‚
â”‚         â”‚        â”‚  /complete   â”‚        â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                     â”‚
                                                     â–¼
                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                          â”‚  1. è§£æURLè¯†åˆ«å¹³å° â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                     â”‚
                                                     â–¼
                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                          â”‚  2. è°ƒç”¨å¹³å°çˆ¬è™«    â”‚
                                          â”‚     è·å–ç”¨æˆ·æ•°æ®    â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                     â”‚
                                                     â–¼
                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                          â”‚  3. è°ƒç”¨å¹³å°çˆ¬è™«    â”‚
                                          â”‚     è·å–è§†é¢‘æ•°æ®    â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                     â”‚
                                                     â–¼
                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                          â”‚  4. ç›´æ¥å†™å…¥æ•°æ®åº“  â”‚
                                          â”‚     - creator_accountsâ”‚
                                          â”‚     - videos        â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ›´æ–°è§†é¢‘æ•°æ®æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         â”‚ è§†é¢‘URL â”‚              â”‚        â”‚                 â”‚
â”‚ å‰ç«¯UI  â”‚â”€â”€â”€â”€â”€â”€â”€>â”‚ Scraper API  â”‚â”€â”€â”€â”€â”€â”€â”€>â”‚ ScraperManager  â”‚
â”‚         â”‚        â”‚ /update-videoâ”‚        â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                     â”‚
                                                     â–¼
                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                          â”‚ 1. è§£æè§†é¢‘URLè·å–IDâ”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                     â”‚
                                                     â–¼
                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                          â”‚ 2. æŸ¥è¯¢æ•°æ®åº“ç¡®è®¤   â”‚
                                          â”‚    è§†é¢‘æ˜¯å¦å­˜åœ¨     â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                     â”‚
                                                     â–¼
                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                          â”‚ 3. è°ƒç”¨å¹³å°çˆ¬è™«     â”‚
                                          â”‚    è·å–æœ€æ–°æ•°æ®     â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                     â”‚
                                                     â–¼
                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                          â”‚ 4. æ›´æ–°æ•°æ®åº“è®°å½•   â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âš ï¸ é‡è¦è®¾è®¡åŸåˆ™

### èŒè´£åˆ†ç¦»
1. **Scrapersæ¨¡å—** - æ•°æ®è·å–å±‚
   - è´Ÿè´£**å¦‚ä½•è·å–æ•°æ®**ï¼ˆæŠ€æœ¯å…³æ³¨ç‚¹ï¼‰
   - è°ƒç”¨å¤–éƒ¨API
   - è§£æå’Œè½¬æ¢æ•°æ®æ ¼å¼
   - å­˜å‚¨åŸå§‹æ•°æ®

2. **Platformsæ¨¡å—** - ä¸šåŠ¡ç®¡ç†å±‚
   - è´Ÿè´£**å¦‚ä½•ä½¿ç”¨æ•°æ®**ï¼ˆä¸šåŠ¡å…³æ³¨ç‚¹ï¼‰
   - æŸ¥è¯¢å’Œå±•ç¤º
   - ä¸šåŠ¡é€»è¾‘å¤„ç†
   - æ•°æ®ç®¡ç†ï¼ˆåˆ é™¤ã€æ›´æ–°ç­‰ï¼‰

3. **ä¸ºä»€ä¹ˆä¸åˆå¹¶ï¼Ÿ**
   - âœ… **å•ä¸€èŒè´£**: æ¯ä¸ªæ¨¡å—èšç„¦è‡ªå·±çš„é¢†åŸŸ
   - âœ… **å¯æ‰©å±•æ€§**: Platformsæœªæ¥å¯èƒ½éœ€è¦æ ‡ç­¾ã€åˆ†ç»„ã€å¯¼å‡ºç­‰ä¸šåŠ¡åŠŸèƒ½
   - âœ… **å¯ç»´æŠ¤æ€§**: ä¸šåŠ¡å˜æ›´ä¸å½±å“çˆ¬è™«ï¼Œçˆ¬è™«å˜æ›´ä¸å½±å“ä¸šåŠ¡
   - âœ… **ä¾èµ–æ–¹å‘**: Scraperså¯ä»¥ä¾èµ–Platformsçš„æ•°æ®æ¨¡å‹ï¼Œåä¹‹ä¸è¡Œ

### ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

#### âŒ é”™è¯¯çš„è®¾è®¡ï¼ˆä¹‹å‰çš„æ–¹å¼ï¼‰:
```typescript
// platformController.createOrUpdateCreatorAccount
async createOrUpdateCreatorAccount(req, res) {
  // é—®é¢˜ï¼šä¸€ä¸ª"åˆ›å»º/æ›´æ–°"æ¥å£å†…éƒ¨è§¦å‘äº†çˆ¬è™«
  const crawler = await getPlatformCrawler(platform)
  const data = await crawler.getUserInfo()  // è§¦å‘å¤–éƒ¨APIè°ƒç”¨
  // ...å­˜å‚¨æ•°æ®
}
```

**é—®é¢˜**:
- æ¥å£åç§°è¯¯å¯¼ï¼ˆçœ‹èµ·æ¥æ˜¯CRUDï¼Œå®é™…æ˜¯çˆ¬è™«ï¼‰
- èŒè´£ä¸æ¸…æ™°
- ä¸å¯é¢„æµ‹çš„æ€§èƒ½å½±å“
- æ¨¡å—é—´è€¦åˆä¸¥é‡

#### âœ… æ­£ç¡®çš„è®¾è®¡ï¼ˆå½“å‰æ–¹å¼ï¼‰:

```typescript
// scraperController.scrapeComplete
async scrapeComplete(req, res) {
  // æ¸…æ™°ï¼šè¿™æ˜¯ä¸€ä¸ªçˆ¬è™«æ¥å£ï¼Œä¼šè§¦å‘æ•°æ®æŠ“å–
  const result = await scraperManager.scrapeAndStoreCreatorAccount({
    url: req.body.url
  })
  // è¿”å›æŠ“å–ç»“æœ
}

// platformManager.createOrUpdateCreatorAccount
async createOrUpdateCreatorAccount(params) {
  // æ¸…æ™°ï¼šçº¯CRUDæ“ä½œï¼Œä¸è§¦å‘çˆ¬è™«
  // åªæ¥å—å·²å¤„ç†çš„æ•°æ®ï¼Œç›´æ¥å­˜å‚¨åˆ°æ•°æ®åº“
  await db.insert(creatorAccounts).values(params)
}
```

**ä¼˜åŠ¿**:
- èŒè´£æ¸…æ™°ï¼šçˆ¬è™«å°±æ˜¯çˆ¬è™«ï¼ŒCRUDå°±æ˜¯CRUD
- æ¥å£è¯­ä¹‰æ˜ç¡®
- æ¨¡å—è§£è€¦
- æ˜“äºæµ‹è¯•å’Œç»´æŠ¤

---

## ğŸ“ APIä½¿ç”¨å»ºè®®

### å‰ç«¯å¼€å‘è€…
- **æ·»åŠ æ–°è´¦å·**: ä½¿ç”¨ `POST /api/scrape/complete`
- **æ›´æ–°è§†é¢‘æ•°æ®**: ä½¿ç”¨ `POST /api/scrape/update-video`
- **æŸ¥è¯¢è´¦å·åˆ—è¡¨**: ä½¿ç”¨ `GET /api/platforms/accounts`
- **åˆ é™¤è´¦å·**: ä½¿ç”¨ `DELETE /api/platforms/accounts/:id`

### åç«¯å¼€å‘è€…
- æ•°æ®æŠ“å–ç›¸å…³åŠŸèƒ½ â†’ åœ¨ `scrapers` æ¨¡å—å®ç°
- çº¯æ•°æ®æŸ¥è¯¢å’Œç®¡ç† â†’ åœ¨ `platforms` æ¨¡å—å®ç°
- æ–°å¢çˆ¬è™«é€‚é…å™¨ â†’ å®ç° `ICrawler` æ¥å£

---

## ğŸ” ä»£ç ç¤ºä¾‹

### å‰ç«¯ï¼šæ·»åŠ è´¦å·
```typescript
// âœ… æ­£ç¡®ï¼šè°ƒç”¨çˆ¬è™«æ¥å£
const response = await axios.post("/api/scrape/complete", {
  url: "https://www.tiktok.com/@username"
})

// âŒ é”™è¯¯ï¼šä¸è¦è°ƒç”¨å¹³å°CRUDæ¥å£æœŸæœ›è§¦å‘çˆ¬è™«
const response = await axios.post("/api/platforms/accounts", {
  platform: "tiktok",
  identifier: "username"
})
```

### åç«¯ï¼šå®ç°æ–°å¹³å°çˆ¬è™«
```typescript
// 1. åˆ›å»ºå¹³å°é€‚é…å™¨
export class InstagramAdapter implements ICrawler {
  async getUserInfo(url: string): Promise<any> {
    // è°ƒç”¨Instagram API
  }

  async getUserVideos(url: string): Promise<any[]> {
    // è°ƒç”¨Instagram API
  }

  async getVideoInfo(videoUrl: string): Promise<any> {
    // è°ƒç”¨Instagram API
  }
}

// 2. æ³¨å†Œåˆ° crawlers/index.ts
export function getPlatformCrawler(platform: string): ICrawler {
  switch (platform) {
    case 'tiktok':
      return new TikTokAdapter()
    case 'instagram':
      return new InstagramAdapter()  // æ–°å¢
    // ...
  }
}
```

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

### æ ¸å¿ƒæ–‡ä»¶
- `src/modules/scrapers/manager/scraper.manager.ts` - çˆ¬è™«ä¸šåŠ¡é€»è¾‘
- `src/modules/scrapers/controller/scraper.controller.ts` - çˆ¬è™«APIç«¯ç‚¹
- `src/modules/scrapers/crawlers/TikTok.ts` - TikToké€‚é…å™¨
- `src/modules/platforms/managers/platform.manager.ts` - å¹³å°CRUDé€»è¾‘
- `src/modules/platforms/controller/platform.controller.ts` - å¹³å°APIç«¯ç‚¹

### æµ‹è¯•æ–‡ä»¶
- `test-update-video.ts` - è§†é¢‘æ›´æ–°æ¥å£æµ‹è¯•
- `test-tiktok-video-api.ts` - TikTok APIæµ‹è¯•

---

## ğŸ¯ æ€»ç»“

**æ ¸å¿ƒæ€æƒ³**:
- çˆ¬è™«æ¨¡å— = æ•°æ®è·å– + å­˜å‚¨
- å¹³å°æ¨¡å— = æ•°æ®ç®¡ç†ï¼ˆæŸ¥è¯¢ã€æ›´æ–°ã€åˆ é™¤ï¼‰
- èŒè´£æ¸…æ™°ï¼Œè¾¹ç•Œæ˜ç¡®ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•
