# Implementation Plan: 简化图片存储加载机制

**Branch**: `002-simplify-image-storage` | **Date**: 2025-10-23 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/002-simplify-image-storage/spec.md`

**Note**: This plan is generated by the `/speckit.plan` command based on the feature specification and clarifications.

## Summary

简化当前复杂的图片存储和加载机制，从数据库的多字段存储（原始URL + 本地路径）简化为统一的单字段存储，提供统一的图片访问接口，自动处理图片本地化、失败重试、占位图降级等逻辑。系统将所有第三方图片自动本地化，使用指数退避重试策略（最多3次），存储空间不足时暂停下载并通知管理员手动清理。提供数据库迁移工具，支持从旧模式安全迁移到新模式，包含自动备份和回滚机制。

## Technical Context

**Language/Version**:
- Backend: TypeScript 5.4+ (Node.js 18+)
- Frontend: TypeScript 5.x (React 19 + Next.js 15)

**Primary Dependencies**:
- Backend: Express.js, Drizzle ORM, PostgreSQL driver (pg), axios (图片下载), node-cron (定时任务)
- Frontend: Next.js 15, React 19, axios (API调用), Radix UI (组件库)

**Storage**:
- Database: PostgreSQL (通过Drizzle ORM访问)
- File Storage: 本地文件系统 (backend/static/images/)

**Testing**:
- Backend: NEEDS CLARIFICATION (当前未检测到测试框架，建议使用 Jest 或 Vitest)
- Frontend: NEEDS CLARIFICATION (当前未检测到测试框架，建议使用 Vitest + React Testing Library)

**Target Platform**:
- Backend: Node.js 服务器 (Cloudflare Workers 或传统服务器)
- Frontend: Web (Next.js 应用，部署在 Cloudflare Pages)

**Project Type**: Web application (frontend + backend 分离架构)

**Performance Goals**:
- 已本地化图片响应时间 < 200ms (P95)
- 批量下载：10000张图片在1小时内完成
- 图片重复下载率 < 5%

**Constraints**:
- 迁移脚本执行时间 < 5分钟
- 存储空间手动管理（管理员清理）
- 所有第三方图片必须本地化

**Scale/Scope**:
- 当前数据规模：估计数千账号 + 数万视频
- 图片类型：2种（头像、视频缩略图）
- 数据库字段简化：从每类型2个字段减少到1个

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

**Status**: ⚠️ **项目章程未定义**

项目的 `.specify/memory/constitution.md` 文件当前为空模板，尚未填充实际的开发原则和约束。建议在继续之前填充章程内容，包括：
- 代码质量标准
- 测试要求（单元测试、集成测试覆盖率）
- 安全和性能约束
- 架构原则

**临时评估** (基于行业最佳实践):
- ✅ **单一职责**: 功能范围明确（仅处理图片存储加载，不涉及编辑/压缩）
- ✅ **向后兼容**: 包含迁移工具，支持从旧模式平滑迁移
- ⚠️ **测试覆盖**: 需要补充测试框架和测试策略
- ✅ **错误处理**: 包含重试、回滚、降级机制
- ✅ **可观测性**: 包含统计信息查看、失败原因记录

## Project Structure

### Documentation (this feature)

```text
specs/002-simplify-image-storage/
├── spec.md              # 功能规格说明 ✅
├── plan.md              # 本文件 (实施计划) ✅
├── research.md          # Phase 0 输出 (技术研究)
├── data-model.md        # Phase 1 输出 (数据模型设计)
├── quickstart.md        # Phase 1 输出 (开发快速入门)
├── contracts/           # Phase 1 输出 (API 契约)
│   ├── image-api.yaml   # 图片访问API OpenAPI规范
│   └── migration-api.yaml # 迁移工具API规范
├── checklists/          # 质量检查清单 ✅
│   └── requirements.md
└── tasks.md             # Phase 2 输出 (由 /speckit.tasks 创建)
```

### Source Code (repository root)

```text
backend/
├── src/
│   ├── shared/
│   │   ├── database/
│   │   │   └── schema.ts          # 现有数据库模式
│   │   └── services/
│   │       └── ImageDownloadService.ts  # 现有图片下载服务
│   ├── routes/
│   │   ├── image-proxy.ts         # 现有图片代理路由
│   │   ├── images.ts              # 新增：统一图片访问API
│   │   └── migration.ts           # 新增：迁移管理API
│   ├── services/
│   │   ├── ImageStorageService.ts # 新增：统一图片存储服务
│   │   ├── ImageMigrationService.ts # 新增：迁移服务
│   │   └── StorageMonitorService.ts # 新增：存储监控服务
│   ├── jobs/
│   │   └── image-download-worker.ts # 新增：后台下载任务
│   └── index.ts
├── scripts/
│   ├── migrate-image-fields.ts    # 新增：数据库迁移脚本
│   └── cleanup-storage.ts         # 新增：存储清理脚本
└── static/
    └── images/
        ├── avatars/                # 现有：头像存储
        ├── thumbnails/             # 现有：缩略图存储
        ├── proxied/                # 现有：代理缓存
        └── placeholders/           # 新增：占位图资源
            ├── avatar-default.svg
            └── video-default.svg

frontend/
├── app/
│   ├── accounts/page.tsx           # 需修改：使用新的图片URL
│   ├── videos/page.tsx             # 需修改：使用新的图片URL
│   └── dashboard/page.tsx
├── components/
│   ├── dashboard/
│   │   ├── trending-videos.tsx    # 需修改
│   │   └── recent-videos.tsx      # 需修改
│   └── common/
│       └── Image.tsx               # 新增：统一图片组件
├── lib/
│   └── utils.ts                    # 需修改：简化 getDisplayImageUrl
└── hooks/
    └── useImage.ts                 # 新增：图片加载 Hook
```

**Structure Decision**: 选择 Option 2 (Web application) - 项目已明确分为 frontend 和 backend 两个独立目录，使用前后端分离架构。后端提供 REST API，前端使用 Next.js 消费 API。

**实施策略**:
1. 后端优先实施新的统一API和服务
2. 保持旧API兼容性，逐步迁移
3. 前端组件逐个迁移到新API
4. 最后执行数据库迁移和清理

## Complexity Tracking

> **当前无违反章程的复杂性** - 由于项目章程未定义，此部分暂时为空。

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| N/A | N/A | N/A |

## Phase 0: Research & Outline

**目标**: 解决所有技术上下文中的 "NEEDS CLARIFICATION" 项，研究最佳实践。

### Research Tasks

1. **测试框架选型**
   - **问题**: Backend 和 Frontend 当前缺少测试框架
   - **研究内容**:
     - Node.js/TypeScript 生态中的测试框架对比 (Jest vs Vitest vs Node Test Runner)
     - Next.js 15 推荐的测试方案
     - 与现有工具链的集成方式
   - **决策目标**: 选定测试框架并说明原因

2. **图片下载最佳实践**
   - **问题**: 大规模图片下载的性能优化和资源管理
   - **研究内容**:
     - 并发控制策略（队列、限流）
     - 断点续传和部分下载
     - 内存管理和流式处理
     - 第三方库推荐 (axios vs node-fetch vs undici)
   - **决策目标**: 确定下载实现方案

3. **文件存储组织策略**
   - **问题**: 如何高效组织本地存储的图片文件
   - **研究内容**:
     - 目录结构最佳实践（平铺 vs 分层）
     - 文件命名策略（hash vs id-based）
     - 索引和查找优化
     - 存储空间监控方案
   - **决策目标**: 定义文件组织规范

4. **数据库迁移安全策略**
   - **问题**: 大规模数据迁移的安全性和性能
   - **研究内容**:
     - Drizzle ORM 的迁移机制
     - 数据备份和恢复最佳实践
     - 在线迁移 vs 离线迁移
     - 回滚策略和验证方法
   - **决策目标**: 确定迁移实施方案

5. **定时任务和后台作业**
   - **问题**: 图片下载任务的调度和执行机制
   - **研究内容**:
     - node-cron 最佳实践
     - 任务队列实现（简单队列 vs 专业队列如 Bull）
     - 任务状态跟踪和恢复
     - 优雅停机和错误处理
   - **决策目标**: 定义后台任务架构

**输出**: `research.md` 文件，包含所有研究结果和决策

## Phase 1: Design & Contracts

**前置条件**: Phase 0 完成，所有 NEEDS CLARIFICATION 已解决

### 1. Data Model Design

**输出**: `data-model.md`

**内容**:
- 新的数据库模式设计
- Entity-Relationship 图
- 字段类型和约束
- 索引策略
- 迁移映射（旧字段 → 新字段）

**关键实体** (基于spec.md):
1. **统一图片引用** (集成到现有 creatorAccounts 和 videos 表)
   - 简化字段：移除 localAvatarUrl 和 thumbnailLocalPath
   - 保留字段：avatarUrl 和 thumbnailUrl (语义变为"统一图片ID")

2. **图片元数据表** (新增)
   - 原始URL、本地路径、下载状态
   - 访问统计、最后访问时间
   - 重试次数、失败原因

3. **下载任务队列表** (新增)
   - 任务ID、图片URL、优先级
   - 状态、重试次数、下一次重试时间

### 2. API Contracts

**输出**: `contracts/` 目录，包含 OpenAPI 规范

**API端点设计**:

#### 图片访问API (`contracts/image-api.yaml`)
- `GET /api/images/:type/:id` - 统一图片访问接口
  - type: avatar | thumbnail
  - 响应：图片文件或重定向到本地/代理URL

- `GET /api/images/stats` - 图片存储统计
  - 响应：总数量、存储空间、命中率等

#### 迁移管理API (`contracts/migration-api.yaml`)
- `POST /api/migration/start` - 启动迁移
  - 参数：dry_run (是否模拟运行)
  - 响应：迁移任务ID

- `GET /api/migration/status/:taskId` - 查询迁移状态
  - 响应：进度、成功/失败数量、错误列表

- `POST /api/migration/rollback/:taskId` - 回滚迁移
  - 响应：回滚结果

### 3. Frontend Components

**设计规范**:
- 统一图片组件 (`components/common/Image.tsx`)
- 自定义 Hook (`hooks/useImage.ts`)
- 简化的工具函数 (`lib/utils.ts`)

### 4. Agent Context Update

**脚本执行**:
```bash
.specify/scripts/bash/update-agent-context.sh claude
```

**更新内容**:
- 新的技术栈信息（测试框架）
- 新的服务和API
- 数据模型变更

**输出**: `quickstart.md` - 开发者快速入门指南

## Implementation Phases (概览)

### Phase 2: Task Decomposition
*由 `/speckit.tasks` 命令执行，不在本计划范围内*

预期任务分组：
1. **基础设施准备** (P1)
   - 测试框架配置
   - 占位图资源准备
   - 数据库模式设计

2. **后端服务开发** (P1)
   - ImageStorageService 实现
   - 统一图片访问API
   - 下载队列和重试逻辑

3. **前端组件开发** (P1)
   - 统一图片组件
   - 更新现有页面

4. **迁移工具开发** (P3)
   - 迁移脚本
   - 备份和回滚机制

5. **监控和运维** (P2)
   - 存储监控
   - 统计接口

6. **测试和文档** (所有阶段)
   - 单元测试
   - 集成测试
   - API文档

### Phase 3: Implementation
*由开发者按 tasks.md 执行*

### Phase 4: Testing & Deployment
*由开发者执行验收测试和部署*

## Risk Mitigation

| Risk | Mitigation Strategy |
|------|---------------------|
| 迁移过程中数据丢失 | 自动备份 + 回滚机制 + 模拟运行验证 |
| 存储空间快速耗尽 | 空间监控 + 提前告警 + 手动清理机制 |
| 第三方图片大量失效 | 占位图降级 + 失败原因记录 + 手动重试 |
| 性能不达标 | 异步下载 + 本地缓存 + 并发控制 |
| 前端兼容性问题 | 渐进式迁移 + 保持旧API兼容 |

## Success Metrics

基于 spec.md 的成功标准：
- **SC-001**: 前端代码复杂度降低 50%+ (通过代码行数对比)
- **SC-002**: 图片加载成功率 ≥ 99%
- **SC-003**: 本地化图片响应时间 < 200ms (P95)
- **SC-004**: 数据库字段从 2个/类型 → 1个/类型
- **SC-005**: 图片重复下载率 < 5%
- **SC-006**: 10000张图片下载时间 < 1小时
- **SC-007**: 迁移脚本执行 < 5分钟

## Next Steps

1. ✅ **当前阶段**: Plan generation complete
2. ⏭️ **下一步**: 运行 `/speckit.tasks` 生成详细任务清单
3. 📋 **后续**: 按 tasks.md 执行实施

---

**Generated**: 2025-10-23 | **Status**: Phase 1 planning in progress
